// Global Variables
let database = [];
let scannedRecords = [];
let duplicateScans = [];
let currentBadId = '';
let savedDatabases = [];
let currentDatabaseName = '';

// Pagination Variables
let currentPage = 1;
let itemsPerPage = 50;
let filteredRecords = [];

// Sample Data
const sampleData = [
    { empId: '1000333210', name: '‡∏™‡∏Å‡∏±‡∏ç‡∏ç‡∏≤ ‡∏®‡∏£‡∏µ‡∏õ‡∏£‡∏∞‡πÑ‡∏´‡∏°', badId: '1000333210', batch: '‡∏£‡∏∏‡πà‡∏ô 10', phone: '0803917333', dep: 'HDA', area: 'Cleaning', position: 'PART RECEIVING', shift: 'D / E' },
    { empId: '1000333203', name: '‡∏™‡∏£‡∏±‡∏ç‡∏ç‡∏≤ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏¥‡∏•‡∏õ', badId: '1000333203', batch: '‡∏£‡∏∏‡πà‡∏ô 10', phone: '0982374272', dep: 'HDA', area: 'Cleaning', position: 'PART RECEIVING', shift: 'D / E' },
    { empId: '1000333301', name: '‡∏Ñ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ì ‡∏à‡∏¥‡∏ï‡∏ï‡πå‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå', badId: '1000333301', batch: '‡∏£‡∏∏‡πà‡∏ô 10', phone: '0925511437', dep: 'HDA', area: 'Cleaning', position: 'PART RECEIVING', shift: 'D / E' }
];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadFromLocalStorage();
    loadSavedDatabases();
    updateStats();
    updateSavedDatabasesList();
    updateEmployeeCards();
    enableScanIfDatabaseExists();
    
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    
    const scanInput = document.getElementById('scanInput');
    scanInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            processScan(scanInput.value.trim());
        }
    });

    const manualInput = document.getElementById('manualInput');
    manualInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitManualInput();
        }
    });

    document.getElementById('clearAll').addEventListener('change', function(e) {
        if (e.target.checked) {
            document.getElementById('clearScanned').checked = true;
            document.getElementById('clearDatabase').checked = true;
            document.getElementById('clearSavedDb').checked = true;
        }
    });
});

function enableScanIfDatabaseExists() {
    if (database.length > 0) {
        document.getElementById('scanInput').disabled = false;
        document.getElementById('scanWarning').style.display = 'none';
    } else {
        document.getElementById('scanInput').disabled = true;
        document.getElementById('scanWarning').style.display = 'block';
    }
}

function toggleCheckbox(id) {
    const checkbox = document.getElementById(id);
    checkbox.checked = !checkbox.checked;
    
    if (id !== 'clearAll' && !checkbox.checked) {
        document.getElementById('clearAll').checked = false;
    }
}

function showClearDataModal() {
    document.getElementById('clearDataModal').classList.add('show');
}

function closeClearDataModal() {
    document.getElementById('clearDataModal').classList.remove('show');
    document.getElementById('clearScanned').checked = true;
    document.getElementById('clearDatabase').checked = false;
    document.getElementById('clearSavedDb').checked = false;
    document.getElementById('clearAll').checked = false;
}

function confirmClearData() {
    const clearScanned = document.getElementById('clearScanned').checked;
    const clearDatabase = document.getElementById('clearDatabase').checked;
    const clearSavedDb = document.getElementById('clearSavedDb').checked;
    const clearAll = document.getElementById('clearAll').checked;

    if (!clearScanned && !clearDatabase && !clearSavedDb && !clearAll) {
        showNotification('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á', 'warning');
        return;
    }

    let message = '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á';
    const items = [];
    if (clearScanned) items.push('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô');
    if (clearDatabase) items.push('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
    if (clearSavedDb) items.push('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ');
    if (clearAll) items.push('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    
    message += items.join(', ') + ' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ';

    if (!confirm(message)) return;

    if (clearScanned || clearAll) {
        scannedRecords = [];
        duplicateScans = [];
        filteredRecords = [];
        currentPage = 1;
    }

    if (clearDatabase || clearAll) {
        database = [];
        currentDatabaseName = '';
        document.getElementById('uploadStatus').innerHTML = '';
    }

    if (clearSavedDb || clearAll) {
        savedDatabases = [];
        localStorage.removeItem('savedDatabases');
    }

    saveToLocalStorage();
    updateStats();
    updateTable();
    updateSavedDatabasesList();
    updateEmployeeCards();
    enableScanIfDatabaseExists();
    closeClearDataModal();

    showNotification('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}

function clearScannedRecordsOnly() {
    if (scannedRecords.length === 0 && duplicateScans.length === 0) {
        showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á', 'warning');
        return;
    }

    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n(‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)')) return;

    scannedRecords = [];
    duplicateScans = [];
    filteredRecords = [];
    currentPage = 1;
    saveToLocalStorage();
    updateStats();
    updateTable();
    updateEmployeeCards();

    showNotification('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}

function exportScannedRecords() {
    if (scannedRecords.length === 0) {
        showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Export', 'warning');
        return;
    }
    exportToExcel();
}

function saveCurrentDatabase() {
    if (database.length === 0) {
        showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
        return;
    }

    const dbName = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', currentDatabaseName || '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ' + new Date().toLocaleDateString('th-TH'));
    
    if (!dbName) return;

    const dbId = Date.now().toString();
    const newDatabase = {
        id: dbId,
        name: dbName,
        data: [...database],
        count: database.length,
        savedDate: new Date().toLocaleString('th-TH')
    };

    const existingIndex = savedDatabases.findIndex(db => db.name === dbName);
    if (existingIndex >= 0) {
        if (confirm('‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            savedDatabases[existingIndex] = newDatabase;
        } else {
            return;
        }
    } else {
        savedDatabases.push(newDatabase);
    }

    currentDatabaseName = dbName;
    localStorage.setItem('savedDatabases', JSON.stringify(savedDatabases));
    updateSavedDatabasesList();
    showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}

function loadSavedDatabase(dbId) {
    const db = savedDatabases.find(d => d.id === dbId);
    if (!db) return;

    database = [...db.data];
    currentDatabaseName = db.name;
    saveToLocalStorage();
    updateStats();
    updateSavedDatabasesList();
    enableScanIfDatabaseExists();
    
    document.getElementById('uploadStatus').innerHTML = 
        `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "<strong>${db.name}</strong>" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${db.count.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    
    showNotification('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
    document.getElementById('scanInput').focus();
}

function deleteSavedDatabase(dbId) {
    const db = savedDatabases.find(d => d.id === dbId);
    if (!db) return;

    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${db.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    savedDatabases = savedDatabases.filter(d => d.id !== dbId);
    localStorage.setItem('savedDatabases', JSON.stringify(savedDatabases));
    updateSavedDatabasesList();
    showNotification('‚úÖ ‡∏•‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}

function updateSavedDatabasesList() {
    const container = document.getElementById('savedDatabasesList');
    const saveBtn = document.getElementById('saveDbBtn');
    
    saveBtn.style.display = database.length > 0 ? 'block' : 'none';

    if (savedDatabases.length === 0) {
        container.innerHTML = '<div class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</div>';
        return;
    }

    container.innerHTML = savedDatabases.map(db => `
        <div class="database-item ${currentDatabaseName === db.name ? 'active' : ''}">
            <div class="database-info">
                <div class="database-name">${db.name}</div>
                <div class="database-count">${db.count.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${db.savedDate}</div>
            </div>
            <div class="database-actions">
                <button class="btn-small btn-load" onclick="loadSavedDatabase('${db.id}')">‡πÇ‡∏´‡∏•‡∏î</button>
                <button class="btn-small btn-delete" onclick="deleteSavedDatabase('${db.id}')">‡∏•‡∏ö</button>
            </div>
        </div>
    `).join('');
}

function loadSavedDatabases() {
    const saved = localStorage.getItem('savedDatabases');
    if (saved) {
        savedDatabases = JSON.parse(saved);
    }
}

function loadSampleData() {
    database = [...sampleData];
    currentDatabaseName = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á';
    saveToLocalStorage();
    updateStats();
    updateSavedDatabasesList();
    enableScanIfDatabaseExists();
    
    document.getElementById('uploadStatus').innerHTML = 
        `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong>${database.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong>`;
    
    showNotification('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
    document.getElementById('scanInput').focus();
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á handleFileUpload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å
function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    showNotification('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', 'info');

    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array', raw: false });
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
            
            console.log('üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', jsonData.length);
            
            const headers = jsonData[0];
            
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = `
                <strong>‡πÑ‡∏ü‡∏•‡πå:</strong> ${file.name}<br>
                <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß:</strong> ${jsonData.length.toLocaleString()}<br>
                <strong>‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå:</strong> ${headers.join(', ')}<br>
                <strong>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</strong>
            `;
            document.getElementById('debugBox').classList.add('show');
            
            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏∏‡∏î (Chunked Processing)
            database = [];
            const chunkSize = 100;
            let processedRows = 0;
            
            function processChunk(startIndex) {
                const endIndex = Math.min(startIndex + chunkSize, jsonData.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const row = jsonData[i];
                    
                    if (row && row.length > 0 && row[1]) {
                        const employee = {
                            no: String(row[0] || i).trim(),
                            empId: String(row[1] || '').trim(),
                            badId: String(row[2] || '').trim(),
                            name: String(row[3] || '').trim(),
                            batch: String(row[4] || '').trim(),
                            phone: String(row[5] || '').trim(),
                            dep: String(row[6] || '').trim(),
                            area: String(row[7] || '').trim(),
                            position: String(row[8] || '').trim(),
                            shift: String(row[9] || '').trim()
                        };
                        
                        if (employee.empId && employee.name) {
                            database.push(employee);
                        }
                    }
                }
                
                processedRows = endIndex;
                const progress = Math.round((processedRows / jsonData.length) * 100);
                
                debugContent.innerHTML = `
                    <strong>‡πÑ‡∏ü‡∏•‡πå:</strong> ${file.name}<br>
                    <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${jsonData.length.toLocaleString()}<br>
                    <strong>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß:</strong> ${processedRows.toLocaleString()} ‡πÅ‡∏ñ‡∏ß (${progress}%)<br>
                    <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</strong> ${database.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                `;
                
                if (endIndex < jsonData.length) {
                    setTimeout(() => processChunk(endIndex), 10);
                } else {
                    finishProcessing();
                }
            }
            
            function finishProcessing() {
                console.log('‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô:', database.length);

                if (database.length === 0) {
                    showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå', 'error');
                    document.getElementById('uploadStatus').innerHTML = 
                        `<span style="color: #ff6b6b;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå</span>`;
                    return;
                }

                currentDatabaseName = file.name.replace(/\.[^/.]+$/, '');
                saveToLocalStorage();
                updateStats();
                updateSavedDatabasesList();
                enableScanIfDatabaseExists();
                
                document.getElementById('uploadStatus').innerHTML = 
                    `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong>${database.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong>`;
                
                showNotification(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö ${database.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                document.getElementById('scanInput').focus();
                
                setTimeout(() => {
                    document.getElementById('debugBox').classList.remove('show');
                }, 5000);
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 (‡∏Ç‡πâ‡∏≤‡∏° header)
            setTimeout(() => processChunk(1), 100);

        } catch (error) {
            console.error('‚ùå Error:', error);
            showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            document.getElementById('uploadStatus').innerHTML = 
                `<span style="color: #ff6b6b;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span>`;
        }
    };
    
    reader.onerror = function() {
        showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
    };
    
    reader.readAsArrayBuffer(file);
}

function processScan(scannedId) {
    if (!scannedId) return;

    const scanInput = document.getElementById('scanInput');
    currentBadId = scannedId;

    document.getElementById('resultBox').classList.remove('show');
    document.getElementById('manualInputSection').classList.remove('show');

    let person = database.find(p => p.empId === scannedId);
    
    if (!person) {
        person = database.find(p => p.badId === scannedId);
    }

    if (!person) {
        showManualInput(scannedId);
        scanInput.value = '';
        return;
    }

    const today = new Date().toLocaleDateString('th-TH');
    const existingRecord = scannedRecords.find(r => 
        r.empId === person.empId && r.date === today
    );

    if (existingRecord) {
        showDuplicateResult(person, existingRecord);
        
        const now = new Date();
        duplicateScans.push({
            ...person,
            date: now.toLocaleDateString('th-TH'),
            time: now.toLocaleTimeString('th-TH'),
            timestamp: now.getTime()
        });
        
        saveToLocalStorage();
        updateStats();
    } else {
        createRecord(person, 'auto');
    }

    scanInput.value = '';
    setTimeout(() => scanInput.focus(), 100);
}

function showDuplicateResult(person, existingRecord) {
    document.getElementById('resultEmpId').textContent = person.empId;
    document.getElementById('resultName').textContent = person.name;
    document.getElementById('resultBadId').textContent = person.badId;
    
    const now = new Date();
    document.getElementById('resultDate').textContent = now.toLocaleDateString('th-TH');
    document.getElementById('resultTime').textContent = now.toLocaleTimeString('th-TH');
    
    document.getElementById('previousScanTime').textContent = 
        `${existingRecord.date} ‡πÄ‡∏ß‡∏•‡∏≤ ${existingRecord.time}`;
    document.getElementById('duplicateWarning').style.display = 'block';
    
    const resultBox = document.getElementById('resultBox');
    resultBox.classList.remove('error');
    resultBox.classList.add('duplicate');
    resultBox.classList.remove('show');
    setTimeout(() => resultBox.classList.add('show'), 10);

    showNotification(`‚ö†Ô∏è ‡∏ã‡πâ‡∏≥! ${person.name} ‡πÄ‡∏Ñ‡∏¢‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'duplicate');
}

function showManualInput(badId) {
    document.getElementById('badIdScanned').textContent = badId;
    document.getElementById('manualInputSection').classList.add('show');
    document.getElementById('manualInput').value = '';
    document.getElementById('manualInput').focus();
    
    showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'warning');
}

function submitManualInput() {
    const manualEmpId = document.getElementById('manualInput').value.trim();
    
    if (!manualEmpId) {
        showNotification('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'error');
        return;
    }

    const person = database.find(p => p.empId === manualEmpId);
    
    if (!person) {
        showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
        return;
    }

    const today = new Date().toLocaleDateString('th-TH');
    const existingRecord = scannedRecords.find(r => 
        r.empId === person.empId && r.date === today
    );

    if (existingRecord) {
        showDuplicateResult(person, existingRecord);
        
        const now = new Date();
        duplicateScans.push({
            ...person,
            badId: currentBadId,
            date: now.toLocaleDateString('th-TH'),
            time: now.toLocaleTimeString('th-TH'),
            timestamp: now.getTime()
        });
        
        saveToLocalStorage();
        updateStats();
    } else {
        createRecord({...person, badId: currentBadId}, 'manual');
    }
    
    document.getElementById('manualInputSection').classList.remove('show');
    document.getElementById('scanInput').focus();
}

function cancelManualInput() {
    document.getElementById('manualInputSection').classList.remove('show');
    document.getElementById('scanInput').focus();
    currentBadId = '';
}

function createRecord(person, type) {
    const now = new Date();
    const date = now.toLocaleDateString('th-TH');
    const time = now.toLocaleTimeString('th-TH');

    const record = {
        ...person,
        date: date,
        time: time,
        timestamp: now.getTime(),
        type: type
    };

    scannedRecords.unshift(record);
    filteredRecords = [...scannedRecords];
    currentPage = 1;
    saveToLocalStorage();
    showResult(record);
    updateTable();
    updateEmployeeCards();
    updateStats();

    const message = type === 'manual' 
        ? '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Manual): ' + record.name
        : '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + record.name;
    showNotification(message, 'success');
}

function showResult(record) {
    document.getElementById('resultEmpId').textContent = record.empId;
    document.getElementById('resultName').textContent = record.name;
    document.getElementById('resultBadId').textContent = record.badId;
    document.getElementById('resultDate').textContent = record.date;
    document.getElementById('resultTime').textContent = record.time;
    
    document.getElementById('duplicateWarning').style.display = 'none';
    
    const resultBox = document.getElementById('resultBox');
    resultBox.classList.remove('error');
    resultBox.classList.remove('duplicate');
    resultBox.classList.remove('show');
    setTimeout(() => resultBox.classList.add('show'), 10);
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á updateEmployeeCards ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
function updateEmployeeCards() {
    const container = document.getElementById('employeeCardsContainer');
    
    if (scannedRecords.length === 0) {
        container.innerHTML = '<div class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏¢!</div>';
        return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const displayRecords = scannedRecords.slice(0, 10);

    container.innerHTML = displayRecords.map((record, index) => `
        <div class="employee-card-item">
            <div class="card-badge">${index + 1}</div>
            
            <div class="info-grid">
                <div class="info-item box-no">
                    <div class="item-icon">üî¢</div>
                    <div class="item-label">No.</div>
                    <div class="item-value">${index + 1}</div>
                </div>
                
                <div class="info-item box-empid">
                    <div class="item-icon">üÜî</div>
                    <div class="item-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                    <div class="item-value">${record.empId || '-'}</div>
                </div>
                
                <div class="info-item box-badid">
                    <div class="item-icon">üí≥</div>
                    <div class="item-label">Bad ID</div>
                    <div class="item-value">${record.badId || '-'}</div>
                </div>
                
                <div class="info-item box-name">
                    <div class="item-icon">üë§</div>
                    <div class="item-label">‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
                    <div class="item-value">${record.name || '-'}</div>
                </div>
                
                <div class="info-item box-batch">
                    <div class="item-icon">üìÖ</div>
                    <div class="item-label">‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
                    <div class="item-value">${record.batch || '-'}</div>
                </div>
                
                <div class="info-item box-phone">
                    <div class="item-icon">üì±</div>
                    <div class="item-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</div>
                    <div class="item-value">${record.phone || '-'}</div>
                </div>
                
                <div class="info-item box-dep">
                    <div class="item-icon">üè¢</div>
                    <div class="item-label">Dep.</div>
                    <div class="item-value">${record.dep || '-'}</div>
                </div>
                
                <div class="info-item box-area">
                    <div class="item-icon">üìç</div>
                    <div class="item-label">Area</div>
                    <div class="item-value">${record.area || '-'}</div>
                </div>
                
                <div class="info-item box-position">
                    <div class="item-icon">üíº</div>
                    <div class="item-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô</div>
                    <div class="item-value">${record.position || '-'}</div>
                </div>
                
                <div class="info-item box-shift">
                    <div class="item-icon">‚è∞</div>
                    <div class="item-label">‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                    <div class="item-value">${record.shift || '-'}</div>
                </div>
            </div>
            
            <div class="card-actions">
                <button class="action-button btn-delete" onclick="deleteRecord(${index})">
                    üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>
    `).join('');

    if (scannedRecords.length > 10) {
        container.innerHTML += `<div class="empty-state">‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${scannedRecords.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>`;
    }
}

function deleteRecord(index) {
    if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        scannedRecords.splice(index, 1);
        filteredRecords = [...scannedRecords];
        currentPage = 1;
        saveToLocalStorage();
        updateStats();
        updateTable();
        updateEmployeeCards();
        showNotification('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
    }
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á updateTable ‡∏û‡∏£‡πâ‡∏≠‡∏° Pagination
function updateTable() {
    const tbody = document.getElementById('dataTableBody');
    
    if (scannedRecords.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏•‡∏¢!
                </td>
            </tr>
        `;
        return;
    }

    filteredRecords = [...scannedRecords];
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageRecords = filteredRecords.slice(startIndex, endIndex);

    tbody.innerHTML = pageRecords.map((record, idx) => {
        const actualIndex = startIndex + idx;
        return `
            <tr>
                <td>${actualIndex + 1}</td>
                <td>${record.empId || '-'}</td>
                <td>${record.badId || '-'}</td>
                <td>${record.name || '-'}</td>
                <td>${record.batch || '-'}</td>
                <td>${record.phone || '-'}</td>
                <td>${record.dep || '-'}</td>
                <td>${record.area || '-'}</td>
                <td>${record.position || '-'}</td>
                <td>${record.shift || '-'}</td>
                <td>
                    <span class="status-badge ${record.type === 'manual' ? 'status-manual' : 'status-success'}">
                        ${record.type === 'manual' ? '‚úé Manual' : '‚úì Auto'}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
    
    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(filteredRecords.length / itemsPerPage);
    const paginationContainer = document.getElementById('paginationContainer');
    
    if (!paginationContainer) {
        const tableContainer = document.querySelector('.data-table');
        const pagination = document.createElement('div');
        pagination.id = 'paginationContainer';
        pagination.className = 'pagination';
        tableContainer.after(pagination);
    }
    
    const container = document.getElementById('paginationContainer');
    
    if (filteredRecords.length <= itemsPerPage) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'flex';
    
    const startRecord = ((currentPage - 1) * itemsPerPage) + 1;
    const endRecord = Math.min(currentPage * itemsPerPage, filteredRecords.length);
    
    container.innerHTML = `
        <button class="page-btn" onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>
            ‚èÆÔ∏è ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
        </button>
        <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            ‚óÄÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        </button>
        <div class="page-info">
            ‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} / ${totalPages} 
            (‡πÅ‡∏™‡∏î‡∏á ${startRecord.toLocaleString()}-${endRecord.toLocaleString()} ‡∏à‡∏≤‡∏Å ${filteredRecords.length.toLocaleString()})
        </div>
        <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂Ô∏è
        </button>
        <button class="page-btn" onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
            ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‚è≠Ô∏è
        </button>
    `;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredRecords.length / itemsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    updateTable();
    
    // Scroll to top of table
    document.querySelector('.data-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updateStats() {
    document.getElementById('totalScans').textContent = scannedRecords.length.toLocaleString();
    document.getElementById('duplicateScans').textContent = duplicateScans.length.toLocaleString();
    document.getElementById('databaseCount').textContent = database.length.toLocaleString();
    
    const today = new Date().toLocaleDateString('th-TH');
    const todayScans = scannedRecords.filter(r => r.date === today).length;
    document.getElementById('todayScans').textContent = todayScans.toLocaleString();
}

function exportToExcel() {
    if (scannedRecords.length === 0) {
        showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export', 'error');
        return;
    }

    const exportData = scannedRecords.map((record, index) => ({
        'No.': index + 1,
        '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': record.empId,
        'Bad ID': record.badId,
        '‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': record.name,
        '‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô': record.batch || '-',
        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå': record.phone || '-',
        'Dep.': record.dep || '-',
        'Area': record.area || '-',
        '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô': record.position || '-',
        '‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô': record.shift || '-',
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': record.date,
        '‡πÄ‡∏ß‡∏•‡∏≤': record.time,
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': record.type === 'manual' ? 'Manual Input' : 'Auto Scan'
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô");

    ws['!cols'] = [
        { wch: 6 }, { wch: 15 }, { wch: 15 }, { wch: 25 }, 
        { wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 12 },
        { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 12 }, { wch: 15 }
    ];

    const fileName = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showNotification('‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}

function downloadTemplate() {
    const ws = XLSX.utils.json_to_sheet(sampleData.map((item, index) => ({
        'No.': index + 1,
        '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': item.empId,
        'Bad ID': item.badId,
        '‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': item.name,
        '‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô': item.batch,
        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå': item.phone,
        'Dep.': item.dep,
        'Area': item.area,
        '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô': item.position,
        '‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô': item.shift
    })));
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

    ws['!cols'] = [
        { wch: 6 }, { wch: 15 }, { wch: 15 }, { wch: 25 },
        { wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 12 }, { wch: 20 }, { wch: 10 }
    ];

    XLSX.writeFile(wb, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•.xlsx');
    showNotification('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function saveToLocalStorage() {
    try {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        if (database.length > 5000) {
            sessionStorage.setItem('database', JSON.stringify(database));
            localStorage.setItem('databaseSize', database.length);
        } else {
            localStorage.setItem('database', JSON.stringify(database));
        }
        
        localStorage.setItem('currentDatabaseName', currentDatabaseName);
        localStorage.setItem('scannedRecords', JSON.stringify(scannedRecords));
        localStorage.setItem('duplicateScans', JSON.stringify(duplicateScans));
    } catch (e) {
        console.warn('‚ö†Ô∏è LocalStorage Full - ‡πÉ‡∏ä‡πâ SessionStorage ‡πÅ‡∏ó‡∏ô');
        sessionStorage.setItem('database', JSON.stringify(database));
        sessionStorage.setItem('scannedRecords', JSON.stringify(scannedRecords));
    }
}

function loadFromLocalStorage() {
    try {
        let savedDatabase = localStorage.getItem('database');
        if (!savedDatabase) {
            savedDatabase = sessionStorage.getItem('database');
        }
        
        const savedDbName = localStorage.getItem('currentDatabaseName');
        const savedRecords = localStorage.getItem('scannedRecords') || sessionStorage.getItem('scannedRecords');
        const savedDuplicates = localStorage.getItem('duplicateScans');
        
        if (savedDatabase) {
            database = JSON.parse(savedDatabase);
        }

        if (savedDbName) {
            currentDatabaseName = savedDbName;
        }
        
        if (savedRecords) {
            scannedRecords = JSON.parse(savedRecords);
            filteredRecords = [...scannedRecords];
            updateTable();
        }

        if (savedDuplicates) {
            duplicateScans = JSON.parse(savedDuplicates);
        }
    } catch (e) {
        console.error('‚ùå Error loading from storage:', e);
    }
}
